# 001-技術スタック選択

- Status: Accepted
- Date: 2025-01-XX

## Context

チートデイ（リフィード）判定Webサービスを構築するにあたり、以下の要件を満たす必要がありました：

- **リアルタイム性**: 日次データの入力と即座のスコア計算
- **認証・セキュリティ**: 個人の生体データを扱うため、堅牢な認証とデータ分離が必要
- **スケーラビリティ**: 将来的なユーザー増加に対応可能なアーキテクチャ
- **開発速度**: 迅速な開発とデプロイが必要
- **コスト効率**: 初期段階では低コストで運用可能

## Decision

以下の技術スタックを採用します：

### フロントエンド
- **Next.js 14+ (App Router)**: Reactベースのフルスタックフレームワーク
- **TypeScript**: 型安全性の確保
- **Tailwind CSS**: 効率的なUI開発

### バックエンド・インフラ
- **Supabase**: PostgreSQL、認証、ストレージ、Edge Functionsを統合提供
  - PostgreSQL: リレーショナルデータベース
  - Supabase Auth: メールOTP/Google/Apple認証
  - Row Level Security (RLS): データ分離とセキュリティ
  - Edge Functions: サーバーレス関数（RRS計算、通知生成）
  - Storage: エクスポートファイルの保存

### デプロイ
- **Vercel**: Next.jsに最適化されたデプロイプラットフォーム
- **Supabase Cloud**: マネージドデータベースとインフラ

## Consequences

### メリット

- **統合開発環境**: Supabaseにより認証・DB・ストレージが一元管理
- **開発速度**: Next.js + Supabaseの組み合わせで迅速な開発が可能
- **セキュリティ**: RLSによるデータ分離とSupabase Authによる堅牢な認証
- **コスト効率**: 初期段階では無料枠で運用可能（Supabase Free Tier、Vercel Hobby）
- **型安全性**: TypeScriptによる型チェックでバグの早期発見
- **スケーラビリティ**: SupabaseとVercelの自動スケーリングに対応
- **リアルタイム性**: Supabase Realtimeによる即時UI反映が可能

### デメリット

- **ベンダーロックイン**: Supabaseへの依存が発生
- **学習コスト**: Supabase特有の機能（RLS、Edge Functions）の習得が必要
- **制約**: Supabaseの制限（Edge Functionsの実行時間制限など）に留意が必要
- **移行コスト**: 将来的に他のプラットフォームへの移行が困難

## Alternatives Considered

### フロントエンドフレームワーク

- **React + Vite**: Next.jsより軽量だが、SSRやルーティングを自前で実装する必要がある
  - 採用しなかった理由: App Routerによる統合的な開発体験を優先
- **Vue.js + Nuxt**: Next.jsと同等の機能だが、Reactエコシステムの方が豊富
  - 採用しなかった理由: Reactの経験とエコシステムを優先

### バックエンド・データベース

- **Firebase**: Google提供のBaaS
  - 採用しなかった理由: NoSQLベースで、リレーショナルデータの扱いが複雑。PostgreSQLの方が柔軟
- **AWS (RDS + Lambda)**: より柔軟だが設定が複雑
  - 採用しなかった理由: 初期開発速度と運用コストを優先。Supabaseの方がシンプル
- **自前のバックエンド (Node.js + Express)**: 完全な制御が可能
  - 採用しなかった理由: 開発時間とインフラ運用コストを削減するため

### 認証

- **NextAuth.js**: Next.js専用の認証ライブラリ
  - 採用しなかった理由: Supabase Authと統合することで、RLSとの連携が容易
- **Auth0**: エンタープライズ向け認証サービス
  - 採用しなかった理由: コストとSupabase Authの機能で十分

## Implementation

### プロジェクト構成

```
repo/
├─ src/
│  ├─ app/                    # Next.js App Router
│  ├─ components/              # Reactコンポーネント
│  ├─ lib/
│  │  └─ supabase/             # Supabaseクライアント
│  └─ types/                   # TypeScript型定義
├─ supabase/
│  ├─ migrations/              # データベースマイグレーション
│  └─ functions/               # Edge Functions
│      ├─ calc_rrs/            # RRS計算関数
│      ├─ nightly_forecast/    # 通知生成関数
│      └─ export_zip/           # エクスポート関数
└─ package.json                # Next.js + Supabase依存関係
```

### 主要パッケージ

```json
{
  "dependencies": {
    "next": "^14.0.0",
    "react": "^18.0.0",
    "@supabase/supabase-js": "^2.38.0",
    "@supabase/ssr": "^0.0.0"
  },
  "devDependencies": {
    "typescript": "^5.0.0",
    "@types/node": "^20.0.0",
    "@types/react": "^18.0.0"
  }
}
```

### 環境変数

```env
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=xxx
SUPABASE_SERVICE_ROLE_KEY=xxx
```

## Future Considerations

- **パフォーマンス最適化**: Edge Functionsの実行時間制限に達した場合の対応
- **マルチリージョン対応**: 日本以外のユーザー拡大時の対応
- **キャッシュ戦略**: Redis等の導入検討（現時点ではSupabaseのキャッシュで対応）
- **監視・ログ**: DataDogやSentry等の導入検討





